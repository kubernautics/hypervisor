#!/bin/bash
echo ">   Staging Cloudctl Profile ..."
cat <<EOF >/tmp/lxd-profile-cloudctl.yaml
config:
  linux.kernel_modules: ip6table_filter,iptable_filter
  security.nesting: "true"
  security.privileged: "true"
  user.network-config: |
    version: 2
    ethernets:
      eth0:
        dhcp4: true
        dhcp6: false
      eth1:
        dhcp4: false
        dhcp6: false
        addresses: [ ${int_ministack_SUBNET}.3/24 ]
      eth2:
        dhcp4: false
        dhcp6: false
        addresses: [ ${ocp_ministack_SUBNET}.3/24 ]
  user.user-data: |
    #cloud-config
    package_upgrade: true
    packages:
      - jq
      - git
      - vim
      - tree
      - tmux
      - lnav
      - byobu
      - snapd
      - apache2
      - maas-cli
      - squashfuse
      - libvirt-bin
      - python-pip
    users:
      - name: ${ministack_UNAME}
        shell: /bin/bash
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        ssh_import_id: ${ccio_SSH_SERVICE}:${ccio_SSH_UNAME}
    runcmd:
      - [echo, "'testing 123...'", ">", "/root/test.log"]
devices:
  eth0:
    name: eth0
    nictype: bridged
    parent: external
    type: nic
  eth1:
    name: eth1
    nictype: bridged
    parent: internal
    type: nic
  eth2:
    name: eth2
    nictype: bridged
    parent: ocp-mini-stack
    type: nic
  root:
    path: /
    pool: default
    type: disk
  ccio-etc:
    path: /etc/ccio
    source: /etc/ccio
    type: disk
description: ccio mini-stack fedora cloudctl container profile
name: cloudctl
EOF

# Detect && Purge 'cloudctl' Profile
echo ">   Checking for & Removing Pre-Existing CloudCTL Profile ..."
[[ $(lxc profile show cloudctl 2>&1 1>/dev/null ; echo $?) != 0 ]] || lxc profile delete cloudctl

# Create && Write Profile
lxc profile create cloudctl

echo ">   Loading CloudCTL Cloud Init Data"
lxc profile edit cloudctl < <(cat /tmp/lxd-profile-cloudctl.yaml)

echo ">   Created cloudctl profile"
lxc profile list
